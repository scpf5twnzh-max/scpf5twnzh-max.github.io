<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>mybettle - 跨设备同步版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="#4299e1">
    <style>
        /* 原有样式保留 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* 新增：GitHub 同步设置样式 */
        .sync-settings {
            background: #2d3748;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .sync-settings input {
            background: #4a5568;
            border: 1px solid #718096;
            color: white;
            padding: 4px 8px;
            margin: 0 5px;
            border-radius: 4px;
        }
        .sync-status {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .status-online { background: #48bb78; }
        .status-offline { background: #f56565; }

        /* 以下为你原有的样式 */
        .search-bar { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; gap: 10px; }
        .search-label { font-weight: 600; color: #2d3748; }
        .search-input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .search-count { color: #4299e1; font-size: 14px; }
        .reset-btn { background: #f56565; padding: 8px 16px; }
        .category-item { margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .category-header { background: #f8f9fa; padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .category-content { padding: 15px; display: none; }
        .category-content.active { display: block; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .form-group label { width: 80px; font-weight: 500; }
        input, select, button { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        button { background: #4299e1; color: white; border: none; cursor: pointer; }
        button:disabled { background: #a0cfff; cursor: not-allowed; }
        .add-area { margin: 15px 0; padding: 15px; border: 1px solid #4299e1; border-radius: 6px; }
        .add-title { font-weight: 600; margin-bottom: 10px; color: #2d3748; }
        .add-form { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 10px; }
        .parent-btn-list { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 12px; }
        .parent-btn { background: #f0f8fb; border: 1px solid #4299e1; border-radius: 6px; padding: 10px 16px; cursor: pointer; min-width: 220px; text-align: center; }
        .highlight { background: #fff3cd; color: #856404; padding: 0 2px; border-radius: 2px; }
        .parent-btn-content { font-weight: 600; margin-top: 4px; word-break: break-all; }
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 600px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-form-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .modal-form-group label { width: 100px; font-weight: 500; }
        .save-btn { margin-top: 10px; padding: 8px 20px; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- GitHub 同步面板 -->
        <div class="sync-settings">
            <strong>☁️ GitHub 云同步设置</strong>
            <input v-model="ghConfig.token" type="password" placeholder="GitHub Token (ghp_...)">
            <input v-model="ghConfig.owner" placeholder="用户名">
            <input v-model="ghConfig.repo" placeholder="仓库名">
            <button @click="saveConfig" style="background:#48bb78; padding:2px 10px;">连接</button>
            <span :class="['sync-status', ghStatus.connected ? 'status-online' : 'status-offline']">
                {{ ghStatus.message }}
            </span>
            <div style="margin-top: 8px; color: #cbd5e0; font-size: 11px;">
                * Token 请在 GitHub Settings -> Developer settings 中创建。数据将保存为仓库中的 data.json。
            </div>
        </div>

        <!-- 搜索栏 -->
        <div class="search-bar">
            <span class="search-label">全局搜索：</span>
            <input v-model="searchKeyword" class="search-input" placeholder="输入名称、父本、母本关键词...">
            <span class="search-count">找到 {{ filteredTotal }} 条结果</span>
            <button class="reset-btn" @click="searchKeyword = ''" :disabled="!searchKeyword">重置</button>
        </div>

        <!-- 分类列表 -->
        <div v-for="(category, index) in categories" :key="index" class="category-item">
            <div class="category-header" @click="toggleCategory(index)">
                <span>CBF{{index + 1}} <span v-if="searchKeyword" class="search-count">（匹配 {{ getCategoryFilteredCount(index) }}）</span></span>
                <span>{{category.isOpen ? '▼' : '▶'}}</span>
            </div>
            
            <div class="category-content" :class="{active: category.isOpen}">
                <!-- 添加区域 -->
                <div class="add-area">
                    <div class="add-title">添加亲子本</div>
                    <div class="add-form">
                        <template v-if="index === 0">
                            <div class="form-group"><label>父本：</label><input v-model="category.father"></div>
                            <div class="form-group"><label>母本：</label><input v-model="category.mother"></div>
                        </template>
                        <template v-else>
                            <div class="form-group">
                                <label>父本：</label>
                                <select v-model="category.fatherId">
                                    <option value="">请选择CBF{{index}}亲子本</option>
                                    <option v-for="item in getPrevCategorySource(index)" :key="item.id" :value="item.id">{{item.customName}}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>母本：</label>
                                <select v-model="category.motherId">
                                    <option value="">请选择CBF{{index}}亲子本</option>
                                    <option v-for="item in getPrevCategorySource(index)" :key="item.id" :value="item.id">{{item.customName}}</option>
                                </select>
                            </div>
                        </template>
                        <div class="form-group"><label>数量：</label><input v-model.number="category.count" type="number"></div>
                    </div>
                    <button @click="addItems(index)" :disabled="isButtonDisabled(index)">确定添加</button>
                </div>

                <!-- 列表展示 -->
                <div class="parent-btn-list">
                    <div class="parent-btn" v-for="(item, idx) in getFilteredItems(index)" :key="item.id" @click="openModal(index, idx)">
                        <div class="parent-btn-title" v-html="highlightMatch(item.customName)"></div>
                        <div class="parent-btn-content" v-html="highlightMatch(item.fullParentWithBracket)"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详情弹窗 -->
        <div class="modal-mask" v-if="isModalOpen" @click="closeModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>详情修改</h3>
                    <button @click="closeModal">×</button>
                </div>
                <div v-if="currentItem">
                    <div class="modal-form-group"><label>名称：</label><input v-model="currentItem.customName"></div>
                    <div class="modal-form-group"><label>血统：</label><input v-model="currentItem.bloodline"></div>
                    <div class="modal-form-group"><label>体长：</label><input v-model="currentItem.bodyLength"></div>
                    <button class="save-btn" @click="saveItemInfo">保存并同步到云端</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    // GitHub 配置
                    ghConfig: {
                        token: localStorage.getItem('gh_token') || '',
                        owner: localStorage.getItem('gh_owner') || '',
                        repo: localStorage.getItem('gh_repo') || '',
                        path: 'data.json'
                    },
                    ghStatus: { connected: false, message: '未连接' },
                    fileSha: '', // 文件的 SHA 标识，更新时必须

                    categories: [
                        { name: 'CBF1', isOpen: true, father: '', mother: '', count: 1, namePrefix: '', data: [] }
                    ],
                    nextCategoryIndex: 2,
                    isModalOpen: false,
                    currentCategoryIndex: -1,
                    currentItemIndex: -1,
                    currentItem: null,
                    searchKeyword: ''
                }
            },
            computed: {
                filteredTotal() {
                    return this.categories.reduce((total, cate, idx) => total + this.getFilteredItems(idx).length, 0)
                }
            },
            methods: {
                // 保存 GitHub 配置并尝试拉取数据
                saveConfig() {
                    localStorage.setItem('gh_token', this.ghConfig.token);
                    localStorage.setItem('gh_owner', this.ghConfig.owner);
                    localStorage.setItem('gh_repo', this.ghConfig.repo);
                    this.loadFromGitHub();
                },

                // 从 GitHub 读取文件
                async loadFromGitHub() {
                    if (!this.ghConfig.token || !this.ghConfig.owner || !this.ghConfig.repo) {
                        this.ghStatus = { connected: false, message: '请完善同步设置' };
                        return;
                    }
                    const url = `https://api.github.com/repos/${this.ghConfig.owner}/${this.ghConfig.repo}/contents/${this.ghConfig.path}`;
                    try {
                        const res = await fetch(url, {
                            headers: { 'Authorization': `token ${this.ghConfig.token}`, 'Cache-Control': 'no-cache' }
                        });
                        if (res.ok) {
                            const json = await res.json();
                            this.fileSha = json.sha;
                            // 解码 UTF-8 的 Base64
                            const content = decodeURIComponent(escape(atob(json.content)));
                            const cloudData = JSON.parse(content);
                            if (cloudData && cloudData.length > 0) this.categories = cloudData;
                            this.ghStatus = { connected: true, message: '云端同步中' };
                        } else {
                            this.ghStatus = { connected: false, message: '文件不存在或Token无效' };
                        }
                    } catch (e) {
                        this.ghStatus = { connected: false, message: '网络错误' };
                    }
                },

                // 将数据保存回 GitHub
                async saveToGitHub() {
                    if (!this.ghStatus.connected) return;
                    const url = `https://api.github.com/repos/${this.ghConfig.owner}/${this.ghConfig.repo}/contents/${this.ghConfig.path}`;
                    
                    // 编码 UTF-8 的 Base64
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(this.categories, null, 2))));
                    
                    try {
                        const res = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${this.ghConfig.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: "Web Sync: Update Data",
                                content: content,
                                sha: this.fileSha
                            })
                        });
                        if (res.ok) {
                            const json = await res.json();
                            this.fileSha = json.content.sha;
                            console.log("云端保存成功");
                        }
                    } catch (e) {
                        console.error("同步失败", e);
                    }
                },

                // 业务逻辑部分
                toggleCategory(index) {
                    this.categories[index].isOpen = !this.categories[index].isOpen;
                    if (this.categories[index].isOpen && index === this.categories.length - 1) {
                        this.categories.push({
                            name: `CBF${this.nextCategoryIndex++}`, isOpen: false,
                            fatherId: '', motherId: '', formatType: 'nested', count: 1, data: []
                        });
                    }
                },
                getPrevCategorySource(index) { return this.categories[index - 1]?.data || []; },
                isButtonDisabled(index) {
                    const c = this.categories[index];
                    return index === 0 ? (!c.father || !c.mother) : (!c.fatherId || !c.motherId);
                },
                async addItems(index) {
                    const category = this.categories[index];
                    const startSeq = (category.data.length > 0) ? category.data.length + 1 : 1;
                    let newItems = [];

                    for (let i = 0; i < category.count; i++) {
                        const seq = startSeq + i;
                        let item = { id: Date.now() + i, customName: `亲子本${seq}`, bloodline: '', bodyLength: '' };
                        if (index === 0) {
                            item.fullParentWithBracket = `(${category.father}) × (${category.mother})`;
                        } else {
                            const f = this.getPrevCategorySource(index).find(it => it.id === category.fatherId);
                            const m = this.getPrevCategorySource(index).find(it => it.id === category.motherId);
                            item.fullParentWithBracket = `(${f.customName}) × (${m.customName})`;
                        }
                        newItems.push(item);
                    }
                    category.data.push(...newItems);
                    await this.saveToGitHub(); // 保存到 GitHub
                },
                async saveItemInfo() {
                    await this.saveToGitHub();
                    this.closeModal();
                    alert('已同步到 GitHub');
                },
                openModal(catIdx, itemIdx) {
                    const filtered = this.getFilteredItems(catIdx);
                    this.currentItem = filtered[itemIdx];
                    this.currentCategoryIndex = catIdx;
                    this.isModalOpen = true;
                },
                closeModal() { this.isModalOpen = false; },
                getFilteredItems(index) {
                    const kw = this.searchKeyword.toLowerCase();
                    return this.categories[index].data.filter(it => 
                        it.customName.toLowerCase().includes(kw) || it.fullParentWithBracket.toLowerCase().includes(kw)
                    );
                },
                getCategoryFilteredCount(index) { return this.getFilteredItems(index).length; },
                highlightMatch(text) {
                    if (!this.searchKeyword) return text;
                    const regex = new RegExp(`(${this.searchKeyword})`, 'gi');
                    return text.replace(regex, '<span class="highlight">$1</span>');
                }
            },
            mounted() {
                this.loadFromGitHub();
            }
        }).mount('#app')
    </script>
</body>
</html>
