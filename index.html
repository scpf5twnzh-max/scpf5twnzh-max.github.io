<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>mybettle - äº²å­æœ¬äº‘åŒæ­¥ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="#4299e1">
    <style>
        /* æ ¸å¿ƒæ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background-color: #f7fafc; color: #2d3748; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* GitHub åŒæ­¥é¢æ¿ */
        .sync-panel { background: #2d3748; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sync-panel input { background: #4a5568; border: 1px solid #718096; color: white; padding: 6px 10px; border-radius: 4px; font-size: 13px; }
        .sync-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-on { background: #48bb78; color: white; }
        .status-off { background: #f56565; color: white; }

        /* æœç´¢æ  */
        .search-bar { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid #e2e8f0; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; }
        .highlight { background: #fff3cd; color: #856404; padding: 0 2px; }

        /* åˆ†ç±»æ ·å¼ */
        .category-item { margin: 12px 0; border: 1px solid #e2e8f0; border-radius: 8px; background: white; overflow: hidden; }
        .category-header { background: #edf2f7; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .category-content { padding: 20px; display: none; }
        .category-content.active { display: block; }

        /* è¡¨å•ä¸æŒ‰é’® */
        .add-area { background: #f8fafc; border: 1px solid #4299e1; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-group { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
        .form-group label { width: 90px; font-size: 14px; font-weight: 600; }
        input, select { padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; flex: 1; }
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #4299e1; color: white; font-weight: 600; transition: 0.2s; }
        button:hover { background: #3182ce; }
        button:disabled { background: #a0cfff; cursor: not-allowed; }

        /* äº²å­æœ¬æŒ‰é’®åˆ—è¡¨ */
        .parent-btn-list { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px; }
        .parent-btn { background: #f0f8fb; border: 1px solid #4299e1; border-radius: 8px; padding: 12px; cursor: pointer; min-width: 200px; flex: 1; max-width: 300px; }
        .parent-btn:hover { background: #e6f6ff; }
        .parent-btn-title { font-size: 13px; color: #4a5568; }
        .parent-btn-content { font-weight: bold; margin-top: 5px; word-break: break-all; }

        /* å¼¹çª—æ ·å¼ */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .color-group { display: flex; gap: 10px; flex: 1; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- åŒæ­¥é¢æ¿ -->
        <div class="sync-panel">
            <span>â˜ï¸ GitHub åŒæ­¥ï¼š</span>
            <input v-model="gh.token" type="password" placeholder="Token">
            <input v-model="gh.owner" placeholder="ç”¨æˆ·å">
            <input v-model="gh.repo" placeholder="ä»“åº“å">
            <button @click="saveConfig" style="background:#48bb78">è¿æ¥å¹¶æ‹‰å–æ•°æ®</button>
            <span :class="['sync-status', ghStatus.connected ? 'status-on' : 'status-off']">
                {{ ghStatus.message }}
            </span>
        </div>

        <!-- æœç´¢æ  -->
        <div class="search-bar">
            <span style="font-weight:bold">ğŸ” å…¨å±€æœç´¢ï¼š</span>
            <input v-model="searchKeyword" class="search-input" placeholder="è¾“å…¥åç§°ã€çˆ¶æœ¬ã€æ¯æœ¬å…³é”®è¯...">
            <span style="color:#4299e1">æ‰¾åˆ° {{ filteredTotal }} æ¡åŒ¹é…</span>
            <button @click="searchKeyword = ''" v-if="searchKeyword" style="background:#f56565">é‡ç½®</button>
        </div>

        <!-- åˆ†ç±»å¾ªç¯ -->
        <div v-for="(category, index) in categories" :key="index" class="category-item">
            <div class="category-header" @click="toggleCategory(index)">
                <span>CBF{{index + 1}} <span v-if="searchKeyword" style="font-size:12px;color:#4299e1">(åŒ¹é… {{ getCategoryFilteredCount(index) }} æ¡)</span></span>
                <span>{{category.isOpen ? 'â–¼' : 'â–¶'}}</span>
            </div>

            <div class="category-content" :class="{active: category.isOpen}">
                <!-- æ·»åŠ è¡¨å• -->
                <div class="add-area">
                    <h4 style="margin-bottom:15px">æ·»åŠ äº²å­æœ¬ (CBF{{index + 1}})</h4>
                    <div class="add-form">
                        <!-- CBF1 è¾“å…¥æ¡† -->
                        <template v-if="index === 0">
                            <div class="form-group"><label>çˆ¶æœ¬ï¼š</label><input v-model="category.father" placeholder="è¾“å…¥çˆ¶æœ¬ä¿¡æ¯"></div>
                            <div class="form-group"><label>æ¯æœ¬ï¼š</label><input v-model="category.mother" placeholder="è¾“å…¥æ¯æœ¬ä¿¡æ¯"></div>
                        </template>
                        <!-- CBF2+ é€‰æ‹©æ¡† -->
                        <template v-else>
                            <div class="form-group">
                                <label>çˆ¶æœ¬ï¼š</label>
                                <select v-model="category.fatherId">
                                    <option value="">é€‰æ‹©CBF{{index}}æ¥æº</option>
                                    <option v-for="item in getPrevCategorySource(index)" :key="item.id" :value="item.id">
                                        {{item.customName}} - {{item.fullParentWithBracket}}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ¯æœ¬ï¼š</label>
                                <select v-model="category.motherId">
                                    <option value="">é€‰æ‹©CBF{{index}}æ¥æº</option>
                                    <option v-for="item in getPrevCategorySource(index)" :key="item.id" :value="item.id">
                                        {{item.customName}} - {{item.fullParentWithBracket}}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ ¼å¼ï¼š</label>
                                <select v-model="category.formatType">
                                    <option value="nested">åµŒå¥—æ ¼å¼ (é»˜è®¤)</option>
                                    <option value="original">åŸå§‹çˆ¶/æ¯æœ¬æ ¼å¼</option>
                                </select>
                            </div>
                        </template>
                        <div class="form-group"><label>åç§°å‰ç¼€ï¼š</label><input v-model="category.namePrefix" placeholder="å¦‚ï¼šäº²å­æœ¬"></div>
                        <div class="form-group"><label>æ·»åŠ æ•°é‡ï¼š</label><input v-model.number="category.count" type="number" min="1"></div>
                    </div>
                    <button @click="addItems(index)" :disabled="isAddDisabled(index)">æ‰¹é‡/å•ç‹¬æ·»åŠ </button>
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="parent-btn-list">
                    <div class="parent-btn" v-for="(item, idx) in getFilteredItems(index)" :key="item.id" @click="openModal(index, item)">
                        <div class="parent-btn-title" v-html="highlightMatch(item.customName)"></div>
                        <div class="parent-btn-content" v-html="highlightMatch(item.fullParentWithBracket)"></div>
                        <div style="font-size:11px; color:#a0aec0; margin-top:5px" v-if="item.bloodline">è¡€ç»Ÿ: {{item.bloodline}}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— -->
        <div class="modal-mask" v-if="isModalOpen" @click="closeModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>äº²å­æœ¬è¯¦ç»†ä¿¡æ¯</h3>
                    <button @click="closeModal" style="background:none; color:#718096; font-size:24px">Ã—</button>
                </div>
                <div v-if="currentItem">
                    <div class="form-group"><label>è‡ªå®šä¹‰åç§°ï¼š</label><input v-model="currentItem.customName"></div>
                    <div class="form-group"><label>äº²å­æœ¬å…³ç³»ï¼š</label><span style="font-size:13px">{{currentItem.fullParentWithBracket}}</span></div>
                    <div class="form-group">
                        <label>è¡€ç»Ÿï¼š</label>
                        <select v-model="currentItem.bloodline">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="äº®èƒ¸">äº®èƒ¸</option><option value="æ™®">æ™®</option><option value="ç‰ç’ƒ">ç‰ç’ƒ</option><option value="çƒŸèŠ±">çƒŸèŠ±</option>
                        </select>
                    </div>
                    <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="currentItem.bodyLength"></div>
                    
                    <!-- é¢œè‰²é€‰æ‹©å™¨ -->
                    <div class="form-group">
                        <label>èƒ¸éƒ¨é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="currentItem.chestColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="currentItem.chestColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é˜ç¿…é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="currentItem.sheathColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="currentItem.sheathColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div style="margin-top:20px; display:flex; gap:10px">
                        <button @click="saveItemInfo" style="flex:1">ä¿å­˜å¹¶åŒæ­¥äº‘ç«¯</button>
                        <button @click="deleteItem" style="background:#f56565">åˆ é™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    gh: {
                        token: localStorage.getItem('gh_token') || '',
                        owner: localStorage.getItem('gh_owner') || '',
                        repo: localStorage.getItem('gh_repo') || '',
                        path: 'data.json'
                    },
                    ghStatus: { connected: false, message: 'æœªè¿æ¥' },
                    fileSha: '',
                    
                    categories: [
                        { name: 'CBF1', isOpen: true, father: '', mother: '', count: 1, namePrefix: '', data: [] }
                    ],
                    nextCategoryIndex: 2,
                    searchKeyword: '',
                    isModalOpen: false,
                    currentCategoryIndex: -1,
                    currentItem: null
                }
            },
            computed: {
                filteredTotal() {
                    return this.categories.reduce((total, _, idx) => total + this.getFilteredItems(idx).length, 0)
                }
            },
            methods: {
                // --- åŒæ­¥é€»è¾‘ ---
                saveConfig() {
                    localStorage.setItem('gh_token', this.gh.token);
                    localStorage.setItem('gh_owner', this.gh.owner);
                    localStorage.setItem('gh_repo', this.gh.repo);
                    this.loadFromGitHub();
                },
                async loadFromGitHub() {
                    if (!this.gh.token || !this.gh.owner || !this.gh.repo) return;
                    const url = `https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}?t=${Date.now()}`;
                    try {
                        const res = await fetch(url, { headers: { 'Authorization': `token ${this.gh.token}`, 'Accept': 'application/vnd.github.v3+json' } });
                        if (res.status === 200) {
                            const json = await res.json();
                            this.fileSha = json.sha;
                            const content = decodeURIComponent(escape(atob(json.content)));
                            const cloudData = JSON.parse(content);
                            if (Array.isArray(cloudData) && cloudData.length > 0) this.categories = cloudData;
                            this.ghStatus = { connected: true, message: 'äº‘ç«¯å·²è¿æ¥' };
                        } else {
                            this.ghStatus = { connected: false, message: 'æ‰¾ä¸åˆ° data.json' };
                        }
                    } catch (e) { this.ghStatus = { connected: false, message: 'åŒæ­¥å¤±è´¥' }; }
                },
                async syncToCloud() {
                    if (!this.ghStatus.connected) return;
                    const url = `https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}`;
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(this.categories, null, 2))));
                    try {
                        const res = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${this.gh.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: "Sync Update", content, sha: this.fileSha })
                        });
                        if (res.ok) {
                            const json = await res.json();
                            this.fileSha = json.content.sha;
                        }
                    } catch (e) { console.error("Cloud Save Failed", e); }
                },

                // --- ä¸šåŠ¡é€»è¾‘ ---
                toggleCategory(index) {
                    this.categories[index].isOpen = !this.categories[index].isOpen;
                    if (this.categories[index].isOpen && index === this.categories.length - 1) {
                        this.categories.push({
                            name: `CBF${this.nextCategoryIndex++}`, isOpen: false,
                            fatherId: '', motherId: '', formatType: 'nested', count: 1, namePrefix: '', data: []
                        });
                    }
                },
                getPrevCategorySource(index) { return this.categories[index - 1]?.data || []; },
                isAddDisabled(index) {
                    const c = this.categories[index];
                    return index === 0 ? (!c.father || !c.mother) : (!c.fatherId || !c.motherId);
                },
                getMaxSeq(category, prefix) {
                    const regex = new RegExp(`^${prefix}(\\d+)$`);
                    let max = 0;
                    category.data.forEach(it => {
                        const m = it.customName.match(regex);
                        if (m) max = Math.max(max, parseInt(m[1]));
                    });
                    return max;
                },
                async addItems(index) {
                    const category = this.categories[index];
                    const prefix = category.namePrefix.trim() || 'äº²å­æœ¬';
                    const startSeq = this.getMaxSeq(category, prefix) + 1;
                    let newItems = [];

                    for (let i = 0; i < category.count; i++) {
                        let item = { id: Date.now() + i, bloodline: '', bodyLength: '', chestColor1: '', chestColor2: '', sheathColor1: '', sheathColor2: '' };
                        if (index === 0) {
                            item.father = category.father; item.mother = category.mother;
                            item.fullParent = `${item.father}Ã—${item.mother}`;
                            item.fullParentWithBracket = `(${item.father}) Ã— (${item.mother})`;
                        } else {
                            const fItem = this.getPrevCategorySource(index).find(it => it.id === category.fatherId);
                            const mItem = this.getPrevCategorySource(index).find(it => it.id === category.motherId);
                            const fText = category.formatType === 'original' ? (fItem.father || fItem.customName) : fItem.fullParentWithBracket;
                            const mText = category.formatType === 'original' ? (mItem.mother || mItem.customName) : mItem.fullParentWithBracket;
                            item.fullParent = `${fItem.customName}Ã—${mItem.customName}`;
                            item.fullParentWithBracket = `(${fText}) Ã— (${mText})`;
                        }
                        item.customName = `${prefix}${startSeq + i}`;
                        newItems.push(item);
                    }
                    category.data.push(...newItems);
                    await this.syncToCloud();
                    alert("æ·»åŠ å®Œæˆå¹¶åŒæ­¥");
                },
                openModal(catIdx, item) {
                    this.currentCategoryIndex = catIdx;
                    this.currentItem = JSON.parse(JSON.stringify(item)); // æ·±æ‹·è´
                    this.isModalOpen = true;
                },
                closeModal() { this.isModalOpen = false; this.currentItem = null; },
                async saveItemInfo() {
                    const idx = this.categories[this.currentCategoryIndex].data.findIndex(it => it.id === this.currentItem.id);
                    this.categories[this.currentCategoryIndex].data[idx] = this.currentItem;
                    await this.syncToCloud();
                    this.closeModal();
                },
                async deleteItem() {
                    if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
                    this.categories[this.currentCategoryIndex].data = this.categories[this.currentCategoryIndex].data.filter(it => it.id !== this.currentItem.id);
                    await this.syncToCloud();
                    this.closeModal();
                },
                getFilteredItems(index) {
                    const kw = this.searchKeyword.toLowerCase().trim();
                    const data = this.categories[index].data;
                    if (!kw) return data;
                    return data.filter(it => it.customName.toLowerCase().includes(kw) || it.fullParentWithBracket.toLowerCase().includes(kw));
                },
                getCategoryFilteredCount(index) { return this.getFilteredItems(index).length; },
                highlightMatch(text) {
                    if (!this.searchKeyword.trim()) return text;
                    const regex = new RegExp(`(${this.searchKeyword})`, 'gi');
                    return text.replace(regex, '<span class="highlight">$1</span>');
                }
            },
            mounted() { this.loadFromGitHub(); }
        }).mount('#app')
    </script>
</body>
</html>
