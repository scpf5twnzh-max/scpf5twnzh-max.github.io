<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background-color: #f7fafc; color: #2d3748; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }

        /* åŒæ­¥é¢æ¿ */
        .sync-panel { background: #2d3748; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sync-panel input { background: #4a5568; border: 1px solid #718096; color: white; padding: 5px 8px; border-radius: 4px; font-size: 12px; flex:1; min-width:120px; }
        .sync-status { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; white-space:nowrap; }
        .status-on { background: #48bb78; color: white; }
        .status-off { background: #f56565; color: white; }

        /* è¡€è„‰æºå¤´åŒºåŸŸ */
        .bloodline-section { background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 12px; margin-bottom:15px; }
        .bloodline-add-bar { display: flex; align-items: center; gap: 8px; flex-wrap:wrap; margin-bottom:12px; }
        .add-label { font-weight:bold; white-space:nowrap; }
        .add-input { flex: 1; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; min-width:180px; }
        .add-btn { padding:8px 14px; border:none; border-radius:4px; background:#805ad5; color:white; font-weight:600; cursor:pointer; }
        .add-btn:hover { background:#6b46c1; }
        .bloodline-list { max-height:200px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; padding:8px; }
        .bloodline-item { padding:8px 10px; border-bottom:1px solid #f7fafc; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .bloodline-item:hover { background:#edf2f7; }
        .bloodline-item:last-child { border-bottom:none; }
        .bloodline-item-name { font-weight:500; }
        .bloodline-item-desc { font-size:12px; color:#718096; margin-top:2px; }
        .edit-bloodline-btn { padding:5px 8px; background:#4299e1; color:white; border-radius:4px; font-size:12px; cursor:pointer; }

        /* CBFåˆ†ç±» */
        .category-item { margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 8px; background: white; overflow: hidden; }
        .category-header { background: #edf2f7; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .category-content { padding: 15px; display: none; }
        .category-content.active { display: block; }

        /* CBFæ“ä½œæ  */
        .cbf-op-bar { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; align-items:center; }
        .cbf-op-select { padding:7px; border:1px solid #cbd5e0; border-radius:4px; flex:1; min-width:150px; }
        .cbf-op-btn { padding:7px 12px; border:none; border-radius:4px; background:#4299e1; color:white; cursor:pointer; }
        .cbf-op-btn:hover { background:#3182ce; }

        /* äº²å­æœ¬åˆ—è¡¨ */
        .parent-btn-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .parent-btn { background: #f0f8fb; border: 1px solid #4299e1; border-radius: 8px; padding: 10px; cursor: pointer; min-width: 180px; flex: 1; max-width: 300px; }
        .parent-btn:hover { background: #e6f6ff; }
        .parent-btn-title { font-size: 13px; color: #4a5568; }
        .parent-btn-content { font-weight: bold; margin-top: 4px; word-break: break-all; }
        .parent-btn-extra { font-size:11px; color:#a0aec0; margin-top:4px; display:flex; justify-content:space-between; }
        .care-tag { background:#f6ad55; color:white; padding:1px 6px; border-radius:3px; font-size:10px; }
        .care-tags-wrap { display:flex; gap:4px; flex-wrap:wrap; }

        /* å¼¹çª—æ ·å¼ */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .detail-modal-mask { z-index: 1000; }
        .parent-select-modal-mask { z-index: 2000; }
        .care-modal-mask { z-index: 2000; }
        .edit-bloodline-modal-mask { z-index: 2000; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; align-items:center; }
        .modal-close { background:none; color:#718096; font-size:20px; padding:0; cursor:pointer; border:none; }
        .form-group { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap:wrap; }
        .form-group label { width: 80px; font-size: 13px; font-weight: 600; white-space:nowrap; }
        input, select { padding: 7px; border: 1px solid #cbd5e0; border-radius: 4px; flex: 1; min-width:160px; }
        button { padding: 7px 14px; border: none; border-radius: 4px; cursor: pointer; background: #4299e1; color: white; font-weight: 600; transition: 0.2s; font-size:13px; }
        button:hover { background: #3182ce; }
        .delete-btn { background:#f56565; }
        .color-group { display: flex; gap: 8px; flex: 1; flex-wrap:wrap; }
        .care-group { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
        .care-code-wrap { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
        .care-code-item { padding:5px 8px; background:#edf2f7; border-radius:4px; display:flex; align-items:center; gap:4px; }
        .care-code-remove { color:#f56565; cursor:pointer; }

        /* é€‰æ‹©çª—å£åˆ—è¡¨ */
        .select-list { max-height:250px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; margin:10px 0; }
        .select-item { padding:10px 12px; border-bottom:1px solid #f7fafc; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .select-item:hover { background:#edf2f7; }
        .select-item:last-child { border-bottom:none; }
        .select-item-info { flex:1; }
        .select-item-name { font-weight:500; }
        .select-item-desc { font-size:12px; color:#718096; margin-top:2px; }

        /* æŒ‰é’®æ ·å¼ */
        .select-btn { background:#38b2ac !important; }
        .select-btn:hover { background:#319795 !important; }
        .care-btn { background:#f6ad55 !important; margin-left:8px; }
        .care-btn:hover { background:#ed8936 !important; }
        .add-care-code-btn { background:#48bb78 !important; padding:5px 8px; font-size:12px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- GitHubåŒæ­¥é¢æ¿ -->
        <div class="sync-panel">
            <span>â˜ï¸ GitHub åŒæ­¥ï¼š</span>
            <input v-model="gh.token" type="password" placeholder="Token">
            <input v-model="gh.owner" placeholder="ç”¨æˆ·å">
            <input v-model="gh.repo" placeholder="ä»“åº“å">
            <button @click="saveConfig" style="background:#48bb78">è¿æ¥å¹¶æ‹‰å–æ•°æ®</button>
            <span :class="['sync-status', ghStatus.connected ? 'status-on' : 'status-off']">
                {{ ghStatus.message }}
            </span>
        </div>

        <!-- è¡€è„‰æºå¤´åŒºåŸŸï¼ˆåŸè¡€çº¿æ·»åŠ ï¼‰ -->
        <div class="bloodline-section">
            <div class="bloodline-add-bar">
                <span class="add-label">ğŸ§¬ è¡€è„‰æºå¤´ï¼š</span>
                <input v-model="newBloodlineName" class="add-input" placeholder="è¾“å…¥è¡€è„‰åç§°ï¼ˆå¦‚ï¼šäº®èƒ¸ã€ç‰ç’ƒï¼‰">
                <button class="add-btn" @click="openAddBloodlineModal">æ·»åŠ </button>
            </div>
            <div v-if="bloodlineLib.length > 0">
                <div style="font-size:13px; font-weight:600; margin-bottom:8px">å·²æœ‰æºå¤´ï¼š</div>
                <div class="bloodline-list">
                    <div class="bloodline-item" v-for="bl in bloodlineLib" :key="bl.id">
                        <div>
                            <div class="bloodline-item-name">{{bl.bloodline}}</div>
                            <div class="bloodline-item-desc">ä½“é•¿: {{bl.bodyLength || 'æœªçŸ¥'}}mm | èƒ¸éƒ¨: {{bl.chestColor1 || 'æ— '}}</div>
                        </div>
                        <span class="edit-bloodline-btn" @click="openEditBloodlineModal(bl)">ä¿®æ”¹</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CBFåˆ†ç±»å¾ªç¯ -->
        <div v-for="(category, index) in categories" :key="index" class="category-item">
            <div class="category-header" @click="toggleCategory(index)">
                <span>CBF{{index + 1}} 
                    <span style="font-size:12px;color:#4299e1">(å…± {{category.data.length}} æ¡)</span>
                </span>
                <span>{{category.isOpen ? 'â–¼' : 'â–¶'}}</span>
            </div>

            <div class="category-content" :class="{active: category.isOpen}">
                <!-- CBFæ“ä½œæ ï¼ˆåç§°è°ƒæ•´ï¼‰ -->
                <div class="cbf-op-bar">
                    <select v-model="category.selectedBloodlineId" class="cbf-op-select">
                        <option value="">
                            {{index === 0 ? 'é€‰æ‹©' : 'æ·»åŠ æ¬¡çº§è¡€è„‰'}}
                        </option>
                        <option v-for="bl in (index === 0 ? bloodlineLib : categories[index-1].data)" :key="bl.id" :value="bl.id">
                            {{bl.bloodline}}
                        </option>
                    </select>
                    <input v-model.number="category.addCount" type="number" min="1" value="1" class="cbf-op-select" style="flex:0.5" placeholder="æ•°é‡">
                    <button class="cbf-op-btn" @click="addBloodlineToCBF(index)" :disabled="!category.selectedBloodlineId">æ·»åŠ </button>
                </div>

                <!-- äº²å­æœ¬åˆ—è¡¨ -->
                <div class="parent-btn-list">
                    <div class="parent-btn" v-for="(item, idx) in category.data" :key="item.id" @click="openItemDetailModal(index, item)">
                        <div class="parent-btn-title">{{item.bloodline}}</div>
                        <div class="parent-btn-content">{{item.parentRelation || 'æš‚æ— äº²å­å…³ç³»'}}</div>
                        <div class="parent-btn-extra">
                            <span>æ•°é‡: {{item.count || 1}}</span>
                            <div class="care-tags-wrap" v-if="item.careCodes && item.careCodes.length>0">
                                <span class="care-tag" v-for="code in item.careCodes" :key="code">ç‰¹åˆ«å…³å¿ƒ({{code}})</span>
                            </div>
                        </div>
                    </div>
                    <div v-if="category.data.length === 0" style="padding:20px; text-align:center; color:#718096">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ è¡€è„‰æºå¤´å¼¹çª— -->
        <div class="modal-mask" v-if="isAddBloodlineModalOpen" @click="closeAddBloodlineModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>æ·»åŠ è¡€è„‰æºå¤´</h3>
                    <button @click="closeAddBloodlineModal" class="modal-close">Ã—</button>
                </div>
                <div>
                    <div class="form-group"><label>è¡€è„‰åç§°ï¼š</label><input v-model="currentBloodline.bloodline" placeholder="å¦‚ï¼šäº®èƒ¸ã€ç‰ç’ƒ"></div>
                    <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="currentBloodline.bodyLength"></div>
                    <div class="form-group">
                        <label>èƒ¸éƒ¨é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="currentBloodline.chestColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="currentBloodline.chestColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é˜ç¿…é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="currentBloodline.sheathColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="currentBloodline.sheathColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div class="form-group"><label>è¯¦ç»†å¤‡æ³¨ï¼š</label><input v-model="currentBloodline.remark" placeholder="æ·»åŠ è¯¦ç»†è¯´æ˜ä¿¡æ¯"></div>
                    <button @click="saveBloodline" style="width:100%; margin-top:10px">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ä¿®æ”¹è¡€è„‰æºå¤´å¼¹çª— -->
        <div class="modal-mask edit-bloodline-modal-mask" v-if="isEditBloodlineModalOpen" @click="closeEditBloodlineModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>ä¿®æ”¹è¡€è„‰æºå¤´</h3>
                    <button @click="closeEditBloodlineModal" class="modal-close">Ã—</button>
                </div>
                <div>
                    <div class="form-group"><label>è¡€è„‰åç§°ï¼š</label><input v-model="editBloodline.bloodline" placeholder="å¦‚ï¼šäº®èƒ¸ã€ç‰ç’ƒ"></div>
                    <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="editBloodline.bodyLength"></div>
                    <div class="form-group">
                        <label>èƒ¸éƒ¨é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="editBloodline.chestColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="editBloodline.chestColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é˜ç¿…é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="editBloodline.sheathColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="editBloodline.sheathColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div class="form-group"><label>è¯¦ç»†å¤‡æ³¨ï¼š</label><input v-model="editBloodline.remark" placeholder="æ·»åŠ è¯¦ç»†è¯´æ˜ä¿¡æ¯"></div>
                    <button @click="saveEditBloodline" style="width:100%; margin-top:10px">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>

        <!-- äº²å­æœ¬è¯¦æƒ…å¼¹çª— -->
        <div class="modal-mask detail-modal-mask" v-if="isItemDetailModalOpen" @click="closeItemDetailModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>{{currentItem.bloodline || 'è¯¦æƒ…'}}</h3>
                    <button @click="closeItemDetailModal" class="modal-close">Ã—</button>
                </div>
                <div>
                    <div class="form-group"><label>è¡€è„‰åç§°ï¼š</label><span>{{currentItem.bloodline || 'æ— '}}</span></div>
                    <div class="form-group">
                        <label>çˆ¶æœ¬ï¼š</label>
                        <button class="select-btn" @click="openSelectParentModal('father')">é€‰æ‹©çˆ¶æœ¬</button>
                        <span style="margin-left:8px">{{currentItem.fatherName || 'æœªé€‰æ‹©'}}</span>
                    </div>
                    <div class="form-group">
                        <label>æ¯æœ¬ï¼š</label>
                        <button class="select-btn" @click="openSelectParentModal('mother')">é€‰æ‹©æ¯æœ¬</button>
                        <span style="margin-left:8px">{{currentItem.motherName || 'æœªé€‰æ‹©'}}</span>
                    </div>
                    <div class="form-group"><label>äº²å­å…³ç³»ï¼š</label><span>{{currentItem.parentRelation || 'æš‚æ— '}}</span></div>
                    <div class="form-group">
                        <label>ç‰¹åˆ«å…³å¿ƒï¼š</label>
                        <button class="care-btn" @click="openCareModal">{{currentItem.careCodes && currentItem.careCodes.length>0 ? 'ç¼–è¾‘ç‰¹åˆ«å…³å¿ƒ' : 'æ ‡è®°ä¸ºç‰¹åˆ«å…³å¿ƒ'}}</button>
                    </div>
                    <div class="form-group"><label>æ•°é‡ï¼š</label><input v-model.number="currentItem.count" type="number" min="1" :value="currentItem.count || 1"></div>
                    <div style="margin-top:15px; display:flex; gap:8px">
                        <button @click="saveItemDetail" style="flex:1">ä¿å­˜ä¿®æ”¹</button>
                        <button @click="deleteItem" class="delete-btn">åˆ é™¤</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€‰æ‹©çˆ¶æœ¬/æ¯æœ¬å¼¹çª— -->
        <div class="modal-mask parent-select-modal-mask" v-if="isSelectParentModalOpen" @click="closeSelectParentModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>é€‰æ‹©{{selectParentType}}è¡€è„‰</h3>
                    <button @click="closeSelectParentModal" class="modal-close">Ã—</button>
                </div>
                <div class="search-bar" style="margin:10px 0">
                    <input v-model="selectParentKeyword" placeholder="æœç´¢è¡€è„‰åç§°..." class="add-input">
                </div>
                <div class="select-list">
                    <div class="select-item" v-for="bl in filteredParentList" :key="bl.id" @click="confirmParentSelect(bl)">
                        <div class="select-item-info">
                            <div class="select-item-name">{{bl.bloodline}} <span v-if="bl.careCodes && bl.careCodes.length>0" class="care-tag">{{bl.careCodes[0]}}</span></div>
                            <div class="select-item-desc">ä½“é•¿: {{bl.bodyLength || 'æœªçŸ¥'}}mm | èƒ¸éƒ¨: {{bl.chestColor1 || 'æ— '}}+{{bl.chestColor2 || 'æ— '}}</div>
                            <div class="select-item-desc">é˜ç¿…: {{bl.sheathColor1 || 'æ— '}}+{{bl.sheathColor2 || 'æ— '}} | å¤‡æ³¨: {{bl.remark || 'æ— '}}</div>
                        </div>
                    </div>
                    <div v-if="filteredParentList.length === 0" style="padding:20px; text-align:center; color:#718096">æ— åŒ¹é…è¡€è„‰</div>
                </div>
            </div>
        </div>

        <!-- ç‰¹åˆ«å…³å¿ƒå¼¹çª— -->
        <div class="modal-mask care-modal-mask" v-if="isCareModalOpen" @click="closeCareModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>ç‰¹åˆ«å…³å¿ƒè®¾ç½®</h3>
                    <button @click="closeCareModal" class="modal-close">Ã—</button>
                </div>
                <div>
                    <div style="font-size:13px; font-weight:600; margin-bottom:8px">ç‰¹åˆ«å…³å¿ƒç¼–å·ï¼ˆå¯æ·»åŠ å¤šä¸ªï¼‰ï¼š</div>
                    <div class="care-code-wrap">
                        <div class="care-code-item" v-for="(code, idx) in currentCare.careCodes" :key="idx">
                            {{code}}
                            <span class="care-code-remove" @click="removeCareCode(idx)">Ã—</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:4px">
                            <input v-model="newCareCode" placeholder="è¾“å…¥ç¼–å·" style="flex:1; min-width:80px; padding:5px">
                            <button class="add-care-code-btn" @click="addCareCode">+æ·»åŠ </button>
                        </div>
                    </div>
                    <div class="form-group"><label>è¯¦ç»†å¤‡æ³¨ï¼š</label><input v-model="currentCare.remark" placeholder="æ·»åŠ ç‰¹åˆ«è¯´æ˜"></div>
                    <div class="form-group"><label>è›¹é‡(g)ï¼š</label><input v-model="currentCare.pupaWeight"></div>
                    <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="currentCare.bodyLength"></div>
                    <div class="form-group">
                        <label>èƒ¸éƒ¨é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="currentCare.chestColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="currentCare.chestColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é˜ç¿…é¢œè‰²ï¼š</label>
                        <div class="color-group">
                            <select v-model="currentCare.sheathColor1"><option value="">é¢œè‰²1</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                            <select v-model="currentCare.sheathColor2"><option value="">é¢œè‰²2</option><option value="ç»¿">ç»¿</option><option value="çº¢">çº¢</option><option value="è“">è“</option><option value="ç´«">ç´«</option></select>
                        </div>
                    </div>
                    <button @click="saveCareSetting" style="width:100%; margin-top:10px">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { createApp } = Vue;
            createApp({
                data() {
                    return {
                        gh: {
                            token: localStorage.getItem('gh_token') || '',
                            owner: localStorage.getItem('gh_owner') || '',
                            repo: localStorage.getItem('gh_repo') || '',
                            path: 'data.json'
                        },
                        ghStatus: { connected: false, message: 'æœªè¿æ¥' },
                        fileSha: '',
                        
                        // è¡€è„‰åº“ï¼ˆå…¨å±€ï¼‰
                        bloodlineLib: [],
                        // CBFåˆ†ç±»
                        categories: [
                            { name: 'CBF1', isOpen: true, data: [], selectedBloodlineId: '', addCount: 1 }
                        ],
                        nextCategoryIndex: 2,
                        
                        // æ–°å¢è¡€è„‰ç›¸å…³
                        newBloodlineName: '',
                        currentBloodline: { id: '', bloodline: '', bodyLength: '', chestColor1: '', chestColor2: '', sheathColor1: '', sheathColor2: '', remark: '' },
                        isAddBloodlineModalOpen: false,
                        // ä¿®æ”¹è¡€è„‰ç›¸å…³
                        isEditBloodlineModalOpen: false,
                        editBloodline: {},
                        
                        // é€‰æ‹©çˆ¶æœ¬/æ¯æœ¬å¼¹çª—
                        isSelectParentModalOpen: false,
                        selectParentType: 'father',
                        selectParentKeyword: '',
                        // è¯¦æƒ…å¼¹çª—
                        isItemDetailModalOpen: false,
                        currentCategoryIndex: -1,
                        currentItem: {},
                        // ç‰¹åˆ«å…³å¿ƒå¼¹çª—
                        isCareModalOpen: false,
                        currentCare: { careCodes: [], remark: '', pupaWeight: '', bodyLength: '', chestColor1: '', chestColor2: '', sheathColor1: '', sheathColor2: '' },
                        newCareCode: ''
                    };
                },
                computed: {
                    filteredParentList() {
                        if (!this.selectParentKeyword.trim()) return [...this.bloodlineLib, ...this.categories.flatMap(c => c.data)];
                        const kw = this.selectParentKeyword.toLowerCase();
                        return [...this.bloodlineLib, ...this.categories.flatMap(c => c.data)].filter(bl => bl.bloodline.toLowerCase().includes(kw));
                    }
                },
                methods: {
                    // --- äº‘åŒæ­¥é€»è¾‘ ---
                    saveConfig() {
                        localStorage.setItem('gh_token', this.gh.token);
                        localStorage.setItem('gh_owner', this.gh.owner);
                        localStorage.setItem('gh_repo', this.gh.repo);
                        this.loadFromGitHub();
                    },
                    async loadFromGitHub() {
                        if (!this.gh.token || !this.gh.owner || !this.gh.repo) return;
                        try {
                            const res = await fetch(`https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}?t=${Date.now()}`, {
                                headers: {
                                    'Authorization': `token ${this.gh.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            if (res.status === 200) {
                                const json = await res.json();
                                this.fileSha = json.sha;
                                const content = decodeURIComponent(escape(atob(json.content)));
                                const cloudData = JSON.parse(content);
                                if (cloudData.bloodlineLib) this.bloodlineLib = cloudData.bloodlineLib;
                                if (cloudData.categories) this.categories = cloudData.categories;
                                this.nextCategoryIndex = this.categories.length + 1;
                                this.ghStatus = { connected: true, message: 'äº‘ç«¯å·²è¿æ¥' };
                            } else {
                                this.ghStatus = { connected: false, message: 'æ‰¾ä¸åˆ° data.json' };
                            }
                        } catch (e) {
                            this.ghStatus = { connected: false, message: 'åŒæ­¥å¤±è´¥' };
                        }
                    },
                    async syncToCloud() {
                        if (!this.ghStatus.connected) return;
                        const syncData = { bloodlineLib: this.bloodlineLib, categories: this.categories };
                        const content = btoa(unescape(encodeURIComponent(JSON.stringify(syncData, null, 2))));
                        try {
                            const res = await fetch(`https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}`, {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${this.gh.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ message: "Sync Update", content, sha: this.fileSha })
                            });
                            if (res.ok) {
                                const json = await res.json();
                                this.fileSha = json.content.sha;
                            }
                        } catch (e) {
                            console.error("äº‘åŒæ­¥å¤±è´¥", e);
                        }
                    },

                    // --- CBFåˆ†ç±»é€»è¾‘ ---
                    toggleCategory(index) {
                        this.categories[index].isOpen = !this.categories[index].isOpen;
                        if (this.categories[index].isOpen && index === this.categories.length - 1) {
                            this.categories.push({
                                name: `CBF${this.nextCategoryIndex++}`,
                                isOpen: false,
                                data: [],
                                selectedBloodlineId: '',
                                addCount: 1
                            });
                        }
                    },
                    addBloodlineToCBF(cbfIndex) {
                        const cbf = this.categories[cbfIndex];
                        // CBF1é€‰è¡€è„‰æºå¤´ï¼ŒCBF2+é€‰ä¸Šä¸€çº§CBFæ•°æ®
                        const sourceList = cbfIndex === 0 ? this.bloodlineLib : this.categories[cbfIndex-1].data;
                        const bl = sourceList.find(item => item.id === cbf.selectedBloodlineId);
                        if (!bl) return;
                        
                        const existItem = cbf.data.find(item => item.bloodlineId === bl.id);
                        if (existItem) {
                            existItem.count = (existItem.count || 1) + cbf.addCount;
                        } else {
                            cbf.data.push({
                                id: Date.now().toString(),
                                bloodlineId: bl.id,
                                bloodline: bl.bloodline,
                                count: cbf.addCount,
                                fatherId: '',
                                fatherName: '',
                                motherId: '',
                                motherName: '',
                                parentRelation: '',
                                careCodes: [],
                                bodyLength: bl.bodyLength,
                                pupaWeight: bl.pupaWeight,
                                chestColor1: bl.chestColor1,
                                chestColor2: bl.chestColor2,
                                sheathColor1: bl.sheathColor1,
                                sheathColor2: bl.sheathColor2,
                                remark: bl.remark
                            });
                        }
                        this.syncToCloud();
                        cbf.selectedBloodlineId = '';
                        cbf.addCount = 1;
                    },

                    // --- è¡€è„‰æºå¤´å¼¹çª— ---
                    openAddBloodlineModal() {
                        this.currentBloodline = {
                            id: Date.now().toString(),
                            bloodline: this.newBloodlineName || '',
                            bodyLength: '',
                            chestColor1: '',
                            chestColor2: '',
                            sheathColor1: '',
                            sheathColor2: '',
                            remark: ''
                        };
                        this.isAddBloodlineModalOpen = true;
                    },
                    closeAddBloodlineModal() {
                        this.isAddBloodlineModalOpen = false;
                        this.newBloodlineName = '';
                    },
                    saveBloodline() {
                        if (!this.currentBloodline.bloodline.trim()) {
                            alert('è¡€è„‰åç§°ä¸èƒ½ä¸ºç©ºï¼');
                            return;
                        }
                        this.bloodlineLib.push(this.currentBloodline);
                        this.syncToCloud();
                        this.closeAddBloodlineModal();
                        alert('æ·»åŠ æˆåŠŸ');
                    },
                    // ä¿®æ”¹è¡€è„‰æºå¤´
                    openEditBloodlineModal(bl) {
                        this.editBloodline = JSON.parse(JSON.stringify(bl));
                        this.isEditBloodlineModalOpen = true;
                    },
                    closeEditBloodlineModal() {
                        this.isEditBloodlineModalOpen = false;
                    },
                    saveEditBloodline() {
                        const idx = this.bloodlineLib.findIndex(item => item.id === this.editBloodline.id);
                        if (idx > -1) {
                            this.bloodlineLib[idx] = this.editBloodline;
                            this.syncToCloud();
                            this.closeEditBloodlineModal();
                            alert('ä¿®æ”¹æˆåŠŸ');
                        }
                    },

                    // --- é€‰æ‹©çˆ¶æœ¬/æ¯æœ¬å¼¹çª— ---
                    openSelectParentModal(type) {
                        this.selectParentType = type;
                        this.selectParentKeyword = '';
                        this.isSelectParentModalOpen = true;
                    },
                    confirmParentSelect(bl) {
                        if (this.selectParentType === 'father') {
                            this.currentItem.fatherId = bl.id;
                            this.currentItem.fatherName = bl.bloodline;
                        } else {
                            this.currentItem.motherId = bl.id;
                            this.currentItem.motherName = bl.bloodline;
                        }
                        this.currentItem.parentRelation = this.currentItem.fatherName && this.currentItem.motherName 
                            ? `(${this.currentItem.fatherName}) Ã— (${this.currentItem.motherName})` 
                            : '';
                        this.closeSelectParentModal();
                    },
                    closeSelectParentModal() {
                        this.isSelectParentModalOpen = false;
                    },

                    // --- äº²å­æœ¬è¯¦æƒ…å¼¹çª— ---
                    openItemDetailModal(cbfIndex, item) {
                        this.currentCategoryIndex = cbfIndex;
                        this.currentItem = JSON.parse(JSON.stringify(item));
                        this.isItemDetailModalOpen = true;
                    },
                    closeItemDetailModal() {
                        this.isItemDetailModalOpen = false;
                        this.currentItem = {};
                    },
                    saveItemDetail() {
                        const cbf = this.categories[this.currentCategoryIndex];
                        const idx = cbf.data.findIndex(item => item.id === this.currentItem.id);
                        if (idx > -1) {
                            cbf.data[idx] = this.currentItem;
                            // åŒæ­¥æ›´æ–°æºå¤´/ä¸Šçº§æ•°æ®
                            const sourceList = this.currentCategoryIndex === 0 ? this.bloodlineLib : this.categories[this.currentCategoryIndex-1].data;
                            const blIdx = sourceList.findIndex(bl => bl.id === this.currentItem.bloodlineId);
                            if (blIdx > -1) {
                                sourceList[blIdx] = {
                                    ...sourceList[blIdx],
                                    bodyLength: this.currentItem.bodyLength,
                                    pupaWeight: this.currentItem.pupaWeight,
                                    chestColor1: this.currentItem.chestColor1,
                                    chestColor2: this.currentItem.chestColor2,
                                    sheathColor1: this.currentItem.sheathColor1,
                                    sheathColor2: this.currentItem.sheathColor2,
                                    remark: this.currentItem.remark,
                                    careCodes: this.currentItem.careCodes
                                };
                            }
                            this.syncToCloud();
                            this.closeItemDetailModal();
                            alert('ä¿®æ”¹ä¿å­˜æˆåŠŸ');
                        }
                    },
                    deleteItem() {
                        if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
                        const cbf = this.categories[this.currentCategoryIndex];
                        cbf.data = cbf.data.filter(item => item.id !== this.currentItem.id);
                        this.syncToCloud();
                        this.closeItemDetailModal();
                    },

                    // --- ç‰¹åˆ«å…³å¿ƒå¼¹çª— ---
                    openCareModal() {
                        this.currentCare = {
                            careCodes: [...(this.currentItem.careCodes || [])],
                            remark: this.currentItem.remark || '',
                            pupaWeight: this.currentItem.pupaWeight || '',
                            bodyLength: this.currentItem.bodyLength || '',
                            chestColor1: this.currentItem.chestColor1 || '',
                            chestColor2: this.currentItem.chestColor2 || '',
                            sheathColor1: this.currentItem.sheathColor1 || '',
                            sheathColor2: this.currentItem.sheathColor2 || ''
                        };
                        this.newCareCode = '';
                        this.isCareModalOpen = true;
                    },
                    closeCareModal() {
                        this.isCareModalOpen = false;
                    },
                    addCareCode() {
                        if (!this.newCareCode.trim()) return;
                        if (!this.currentCare.careCodes.includes(this.newCareCode)) {
                            this.currentCare.careCodes.push(this.newCareCode);
                        }
                        this.newCareCode = '';
                    },
                    removeCareCode(idx) {
                        this.currentCare.careCodes.splice(idx, 1);
                    },
                    saveCareSetting() {
                        this.currentItem.careCodes = this.currentCare.careCodes;
                        this.currentItem.remark = this.currentCare.remark;
                        this.currentItem.pupaWeight = this.currentCare.pupaWeight;
                        this.currentItem.bodyLength = this.currentCare.bodyLength;
                        this.currentItem.chestColor1 = this.currentCare.chestColor1;
                        this.currentItem.chestColor2 = this.currentCare.chestColor2;
                        this.currentItem.sheathColor1 = this.currentCare.sheathColor1;
                        this.currentItem.sheathColor2 = this.currentCare.sheathColor2;
                        this.closeCareModal();
                    }
                },
                mounted() {
                    this.loadFromGitHub();
                }
            }).mount('#app');
        });
    </script>
</body>
</html>
