<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background-color: #f7fafc; color: #2d3748; min-height: 100vh; padding: 5px; }
        .container { max-width: 1200px; margin: 0 auto; width: 100%; }

        /* åŒæ­¥é¢æ¿ */
        .sync-panel { background: #2d3748; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sync-panel input { background: #4a5568; border: 1px solid #718096; color: white; padding: 5px 8px; border-radius: 4px; font-size: 12px; flex:1; min-width:120px; }
        .sync-status { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; white-space:nowrap; }
        .status-on { background: #48bb78; color: white; }
        .status-off { background: #f56565; color: white; }

        /* è¡€è„‰æºå¤´åŒºåŸŸ */
        .bloodline-section { background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 12px; margin-bottom:15px; }
        .bloodline-add-bar { display: flex; align-items: center; gap: 8px; flex-wrap:wrap; margin-bottom:12px; }
        .add-label { font-weight:bold; white-space:nowrap; }
        .gender-select { padding:8px; border:1px solid #cbd5e0; border-radius:6px; min-width:80px; }
        .add-input { flex: 1; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; min-width:180px; }
        .add-btn { padding:8px 14px; border:none; border-radius:4px; background:#805ad5; color:white; font-weight:600; cursor:pointer; }
        .add-btn:hover { background:#6b46c1; }
        /* å…¬æ¯åˆ†æ  */
        .gender-columns { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
        .gender-column { border:1px solid #e2e8f0; border-radius:6px; padding:8px; }
        .gender-column-header { font-weight:600; padding:8px; background:#edf2f7; border-radius:4px; margin-bottom:8px; }
        .gender-column-header.male { background:#e6f7ff; color:#1890ff; }
        .gender-column-header.female { background:#fff2e8; color:#fa8c16; }
        .bloodline-list { max-height:200px; overflow-y:auto; }
        .bloodline-item { padding:8px 10px; border-bottom:1px solid #f7fafc; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .bloodline-item:hover { background:#edf2f7; }
        .bloodline-item:last-child { border-bottom:none; }
        .bloodline-item-name { font-weight:500; }
        .bloodline-item-desc { font-size:12px; color:#718096; margin-top:2px; }
        .edit-bloodline-btn { padding:5px 8px; background:#4299e1; color:white; border-radius:4px; font-size:12px; cursor:pointer; border:none; }

        /* CBFåˆ†ç±» */
        .category-item { margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 8px; background: white; overflow: hidden; }
        .category-header { background: #edf2f7; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .category-content { padding: 15px; display: none; }
        .category-content.active { display: block; }
        /* æ–°å¢CBFæŒ‰é’®æ ·å¼ */
        .add-cbf-btn { margin:10px 0; padding:8px 16px; border:none; border-radius:6px; background:#2f855a; color:white; font-weight:600; cursor:pointer; width:100%; }
        .add-cbf-btn:hover { background:#276749; }

        /* CBFåŒé€‰æ“ä½œæ  */
        .cbf-op-bar { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; align-items:center; }
        .cbf-op-subbar { display:flex; flex:1; gap:8px; min-width:280px; }
        .cbf-op-select { padding:7px; border:1px solid #cbd5e0; border-radius:4px; flex:1; }
        .cbf-op-name-input { padding:7px; border:1px solid #cbd5e0; border-radius:4px; flex:1; min-width:120px; }
        .cbf-op-count-input { padding:7px; border:1px solid #cbd5e0; border-radius:4px; width:80px; }
        .cbf-op-btn { padding:7px 12px; border:none; border-radius:4px; background:#4299e1; color:white; cursor:pointer; }
        .cbf-op-btn:hover { background:#3182ce; }

        /* äº²å­æœ¬+æ¬¡çº§ç§åˆ—è¡¨ */
        .parent-btn-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .subspecies-header { font-weight:600; margin-top:16px; margin-bottom:8px; color:#fa8c16; }
        .subspecies-gender-columns { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px; }
        .subspecies-gender-column { border:1px solid #ffe0b2; border-radius:6px; padding:8px; }
        .subspecies-gender-column-header { font-weight:600; padding:8px; background:#fff8e1; border-radius:4px; margin-bottom:8px; }
        .subspecies-gender-column-header.male { color:#1890ff; }
        .subspecies-gender-column-header.female { color:#fa8c16; }
        .parent-btn { background: #f0f8fb; border: 1px solid #4299e1; border-radius: 8px; padding: 10px; cursor: pointer; min-width: 180px; flex: 1; max-width: 300px; }
        .subspecies-btn { background: #fff2e8; border: 1px solid #fa8c16; border-radius: 8px; padding: 10px; cursor: pointer; min-width: 180px; flex: 1; max-width: 300px; }
        .parent-btn:hover, .subspecies-btn:hover { background: #e6f6ff; }
        .parent-btn-title { font-size: 13px; color: #4a5568; }
        .parent-btn-parents { font-size:12px; color:#718096; margin-top:4px; }
        .parent-btn-extra { font-size:11px; color:#a0aec0; margin-top:4px; display:flex; justify-content:space-between; }

        /* å¼¹çª—æ ·å¼ï¼ˆå¸¦åŠ¨ç”»ï¼‰ */
        .modal-mask { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; 
            z-index: 9999; 
            opacity: 0; /* åˆå§‹é€æ˜ */
            visibility: hidden; /* åˆå§‹éšè— */
            transition: opacity 0.3s ease, visibility 0.3s ease; /* è¿‡æ¸¡åŠ¨ç”» */
        }
        /* å¼¹çª—æ˜¾ç¤ºçŠ¶æ€ */
        .modal-mask.active { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content { 
            background: white; padding: 20px; border-radius: 12px; 
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            position: relative;
            transform: translateY(20px) scale(0.95); /* åˆå§‹åç§»+ç¼©æ”¾ */
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* è¿‡æ¸¡åŠ¨ç”» */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* å¼¹çª—å†…å®¹æ˜¾ç¤ºçŠ¶æ€ */
        .modal-mask.active .modal-content { 
            transform: translateY(0) scale(1); /* æ¢å¤åŸä½+åŸå¤§å° */
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; align-items:center; }
        .modal-close { background:none; color:#718096; font-size:20px; padding:0; cursor:pointer; border:none; transition: color 0.2s ease; }
        .modal-close:hover { color:#f56565; }
        .form-group { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap:wrap; }
        .form-group label { width: 80px; font-size: 13px; font-weight: 600; white-space:nowrap; }
        input, select { padding: 7px; border: 1px solid #cbd5e0; border-radius: 4px; flex: 1; min-width:160px; transition: border-color 0.2s ease; }
        input:focus, select:focus { outline: none; border-color: #4299e1; }
        button { padding: 7px 14px; border: none; border-radius: 4px; cursor: pointer; background: #4299e1; color: white; font-weight: 600; transition: 0.2s; font-size:13px; }
        button:hover { background: #3182ce; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .delete-btn { background:#f56565; }
        .delete-btn:hover { background:#e53e3e; }
        .color-group { display: flex; gap: 8px; flex: 1; flex-wrap:wrap; }
        .subspecies-code-wrap { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
        .subspecies-code-item { padding:5px 8px; background:#edf2f7; border-radius:4px; display:flex; align-items:center; gap:4px; transition: background-color 0.2s ease; }
        .subspecies-code-item:hover { background:#dee2e6; }
        .subspecies-code-remove { color:#f56565; cursor:pointer; transition: color 0.2s ease; }
        .subspecies-code-remove:hover { color:#e53e3e; }
        .add-subspecies-btn { background:#fa8c16 !important; margin-bottom:10px; }
        .add-subspecies-btn:hover { background:#dd6b20 !important; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- GitHubåŒæ­¥é¢æ¿ -->
        <div class="sync-panel">
            <span>â˜ï¸ åŒæ­¥ï¼š</span>
            <input v-model="gh.token" type="password" placeholder="Token">
            <input v-model="gh.owner" placeholder="ç”¨æˆ·å">
            <input v-model="gh.repo" placeholder="ä»“åº“å">
            <button @click="saveConfig" style="background:#48bb78">è¿æ¥æ‹‰å–</button>
            <span :class="['sync-status', ghStatus.connected ? 'status-on' : 'status-off']">
                {{ ghStatus.message }}
            </span>
        </div>

        <!-- è¡€è„‰æºå¤´åŒºåŸŸ -->
        <div class="bloodline-section">
            <div class="bloodline-add-bar">
                <span class="add-label">ğŸ§¬ è¡€è„‰æºå¤´ï¼š</span>
                <select class="gender-select" v-model="newBloodlineGender">
                    <option value="male">å…¬</option>
                    <option value="female">æ¯</option>
                </select>
                <input v-model="newBloodlineName" class="add-input" placeholder="äº®èƒ¸ã€ç‰ç’ƒç­‰">
                <button class="add-btn" @click="openAddBloodlineModal">æ·»åŠ </button>
            </div>
            
            <div class="gender-columns">
                <div class="gender-column">
                    <div class="gender-column-header male">å…¬è¡€è„‰</div>
                    <div class="bloodline-list">
                        <div class="bloodline-item" v-for="bl in maleBloodlines" :key="bl.id">
                            <div>
                                <div class="bloodline-item-name">{{ bl.bloodline }}</div>
                                <div class="bloodline-item-desc">ä½“é•¿: {{ bl.bodyLength || 'æœªçŸ¥' }}mm | èƒ¸è‰²: {{ bl.chestColor1 || 'æ— ' }}</div>
                            </div>
                            <button class="edit-bloodline-btn" @click="openEditBloodlineModal(bl)">æ”¹</button>
                        </div>
                        <div v-if="maleBloodlines.length === 0" style="padding:20px; text-align:center; color:#718096">æš‚æ— å…¬è¡€è„‰</div>
                    </div>
                </div>
                <div class="gender-column">
                    <div class="gender-column-header female">æ¯è¡€è„‰</div>
                    <div class="bloodline-list">
                        <div class="bloodline-item" v-for="bl in femaleBloodlines" :key="bl.id">
                            <div>
                                <div class="bloodline-item-name">{{ bl.bloodline }}</div>
                                <div class="bloodline-item-desc">ä½“é•¿: {{ bl.bodyLength || 'æœªçŸ¥' }}mm | èƒ¸è‰²: {{ bl.chestColor1 || 'æ— ' }}</div>
                            </div>
                            <button class="edit-bloodline-btn" @click="openEditBloodlineModal(bl)">æ”¹</button>
                        </div>
                        <div v-if="femaleBloodlines.length === 0" style="padding:20px; text-align:center; color:#718096">æš‚æ— æ¯è¡€è„‰</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢CBFæŒ‰é’® -->
        <button class="add-cbf-btn" @click="addNewCBFCategory">+ æ–°å¢CBFåˆ†ç±»</button>

        <!-- CBFåˆ†ç±»å¾ªç¯ -->
        <div v-for="(category, index) in categories" :key="category.id" class="category-item">
            <div class="category-header" @click="toggleCategory(index)">
                <span>CBF{{ index + 1 }} (å…± {{ category.data.length + category.subspeciesList.length }} æ¡)</span>
                <span>{{ category.isOpen ? 'â–¼' : 'â–¶' }}</span>
            </div>
            <div class="category-content" :class="{active: category.isOpen}">
                <div class="cbf-op-bar">
                    <div class="cbf-op-subbar">
                        <select v-model="category.selectedMaleId" class="cbf-op-select" :disabled="getMaleOptionList(index).length === 0">
                            <option value="">é€‰å…¬æœ¬</option>
                            <option v-for="bl in getMaleOptionList(index)" :key="bl.id" :value="bl.id">
                                {{ bl.bloodline }} {{ index > 0 ? `(${bl.code})` : '' }}
                            </option>
                        </select>
                        <select v-model="category.selectedFemaleId" class="cbf-op-select" :disabled="getFemaleOptionList(index).length === 0">
                            <option value="">é€‰æ¯æœ¬</option>
                            <option v-for="bl in getFemaleOptionList(index)" :key="bl.id" :value="bl.id">
                                {{ bl.bloodline }} {{ index > 0 ? `(${bl.code})` : '' }}
                            </option>
                        </select>
                    </div>
                    <input v-model="category.newBloodlineName" class="cbf-op-name-input" placeholder="æ–°è¡€è„‰å">
                    <input v-model.number="category.addCount" type="number" min="1" class="cbf-op-count-input" value="1">
                    <button class="cbf-op-btn" @click="addBloodlineToCBF(index)" :disabled="!category.selectedMaleId || !category.selectedFemaleId || !category.newBloodlineName.trim()">æ·»åŠ </button>
                </div>

                <div class="parent-btn-list">
                    <div class="parent-btn" v-for="item in category.data" :key="item.id" @click="openItemDetailModal(index, item)">
                        <div class="parent-btn-title">{{ item.bloodline }}</div>
                        <div class="parent-btn-parents">çˆ¶: {{ item.fatherName }} | æ¯: {{ item.motherName }}</div>
                        <div class="parent-btn-extra"><span>æ•°é‡: {{ item.count || 1 }}</span></div>
                    </div>
                </div>

                <div v-if="category.subspeciesList.length > 0">
                    <div class="subspecies-header">æ¬¡çº§ç§</div>
                    <div class="subspecies-gender-columns">
                        <div class="subspecies-gender-column">
                            <div class="subspecies-gender-column-header male">å…¬æ¬¡çº§ç§</div>
                            <div class="parent-btn-list">
                                <div class="subspecies-btn" v-for="item in getSubspeciesMale(index)" :key="item.id" @click="openSubspeciesDetailModal(index, item)">
                                    <div class="parent-btn-title">{{ item.bloodline }} ({{ item.code }})</div>
                                    <div class="parent-btn-parents">çˆ¶: {{ item.fatherName }} | æ¯: {{ item.motherName }}</div>
                                </div>
                                <div v-if="getSubspeciesMale(index).length === 0" style="padding:16px; text-align:center; color:#718096">æš‚æ— å…¬æ¬¡çº§ç§</div>
                            </div>
                        </div>
                        <div class="subspecies-gender-column">
                            <div class="subspecies-gender-column-header female">æ¯æ¬¡çº§ç§</div>
                            <div class="parent-btn-list">
                                <div class="subspecies-btn" v-for="item in getSubspeciesFemale(index)" :key="item.id" @click="openSubspeciesDetailModal(index, item)">
                                    <div class="parent-btn-title">{{ item.bloodline }} ({{ item.code }})</div>
                                    <div class="parent-btn-parents">çˆ¶: {{ item.fatherName }} | æ¯: {{ item.motherName }}</div>
                                </div>
                                <div v-if="getSubspeciesFemale(index).length === 0" style="padding:16px; text-align:center; color:#718096">æš‚æ— æ¯æ¬¡çº§ç§</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="category.data.length === 0 && category.subspeciesList.length === 0" style="padding:20px; text-align:center; color:#718096">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <!-- å¼¹çª—åŒºåŸŸï¼ˆå¸¦åŠ¨ç”»ï¼‰ -->
        <!-- æ·»åŠ è¡€è„‰å¼¹çª— -->
        <div class="modal-mask" :class="{active: isAddBloodlineModalOpen}" @click="closeAddBloodlineModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>æ·»åŠ è¡€è„‰æºå¤´</h3>
                    <button @click="closeAddBloodlineModal" class="modal-close">Ã—</button>
                </div>
                <div class="form-group"><label>æ€§åˆ«ï¼š</label><select v-model="currentBloodline.gender"><option value="male">å…¬</option><option value="female">æ¯</option></select></div>
                <div class="form-group"><label>è¡€è„‰åï¼š</label><input v-model="currentBloodline.bloodline" placeholder="å¿…å¡«"></div>
                <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="currentBloodline.bodyLength"></div>
                <div class="form-group"><label>èƒ¸è‰²ï¼š</label><div class="color-group"><select v-model="currentBloodline.chestColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="currentBloodline.chestColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>é˜ç¿…è‰²ï¼š</label><div class="color-group"><select v-model="currentBloodline.sheathColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="currentBloodline.sheathColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>å¤‡æ³¨ï¼š</label><input v-model="currentBloodline.remark"></div>
                <button @click="saveBloodline" style="width:100%; margin-top:10px">ä¿å­˜</button>
            </div>
        </div>

        <!-- ä¿®æ”¹è¡€è„‰å¼¹çª— -->
        <div class="modal-mask" :class="{active: isEditBloodlineModalOpen}" @click="closeEditBloodlineModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>ä¿®æ”¹è¡€è„‰</h3>
                    <button @click="closeEditBloodlineModal" class="modal-close">Ã—</button>
                </div>
                <div class="form-group"><label>æ€§åˆ«ï¼š</label><select v-model="editBloodline.gender"><option value="male">å…¬</option><option value="female">æ¯</option></select></div>
                <div class="form-group"><label>è¡€è„‰åï¼š</label><input v-model="editBloodline.bloodline"></div>
                <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="editBloodline.bodyLength"></div>
                <div class="form-group"><label>èƒ¸è‰²ï¼š</label><div class="color-group"><select v-model="editBloodline.chestColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="editBloodline.chestColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>é˜ç¿…è‰²ï¼š</label><div class="color-group"><select v-model="editBloodline.sheathColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="editBloodline.sheathColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>å¤‡æ³¨ï¼š</label><input v-model="editBloodline.remark"></div>
                <button @click="saveEditBloodline" style="width:100%; margin-top:10px">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>

        <!-- äº²å­æœ¬è¯¦æƒ…å¼¹çª— -->
        <div class="modal-mask" :class="{active: isItemDetailModalOpen}" @click="closeItemDetailModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>{{ currentItem.bloodline }}</h3>
                    <button @click="closeItemDetailModal" class="modal-close">Ã—</button>
                </div>
                <div class="form-group"><label>è¡€è„‰åï¼š</label><span>{{ currentItem.bloodline }}</span></div>
                <div class="form-group"><label>çˆ¶æœ¬ï¼š</label><span>{{ currentItem.fatherName }}</span></div>
                <div class="form-group"><label>æ¯æœ¬ï¼š</label><span>{{ currentItem.motherName }}</span></div>
                <div class="form-group"><label>æ•°é‡ï¼š</label><input v-model.number="currentItem.count" min="1"></div>
                <div class="form-group"><label>å¤‡æ³¨ï¼š</label><input v-model="currentItem.remark"></div>
                <div class="form-group"><label>æ¬¡çº§ç§ï¼š</label><button class="add-subspecies-btn" @click="openSubspeciesModal">æ ‡è®°ä¸ºæ¬¡çº§ç§</button></div>
                <div style="display:flex; gap:8px; margin-top:15px">
                    <button @click="saveItemDetail" style="flex:1">ä¿å­˜</button>
                    <button @click="deleteItem" class="delete-btn">åˆ é™¤</button>
                </div>
            </div>
        </div>

        <!-- æ¬¡çº§ç§è¯¦æƒ…å¼¹çª— -->
        <div class="modal-mask" :class="{active: isSubspeciesDetailModalOpen}" @click="closeSubspeciesDetailModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>{{ currentSubspeciesItem.bloodline }} ({{ currentSubspeciesItem.code }})</h3>
                    <button @click="closeSubspeciesDetailModal" class="modal-close">Ã—</button>
                </div>
                <div class="form-group"><label>è¡€è„‰åï¼š</label><span>{{ currentSubspeciesItem.bloodline }}</span></div>
                <div class="form-group"><label>ç¼–å·ï¼š</label><span>{{ currentSubspeciesItem.code }}</span></div>
                <div class="form-group"><label>æ€§åˆ«ï¼š</label><span>{{ currentSubspeciesItem.gender === 'male' ? 'å…¬' : 'æ¯' }}</span></div>
                <div class="form-group"><label>çˆ¶æœ¬ï¼š</label><span>{{ currentSubspeciesItem.fatherName }}</span></div>
                <div class="form-group"><label>æ¯æœ¬ï¼š</label><span>{{ currentSubspeciesItem.motherName }}</span></div>
                <div class="form-group"><label>è›¹é‡(g)ï¼š</label><input v-model="currentSubspeciesItem.pupaWeight"></div>
                <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="currentSubspeciesItem.bodyLength"></div>
                <div class="form-group"><label>èƒ¸è‰²ï¼š</label><div class="color-group"><select v-model="currentSubspeciesItem.chestColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="currentSubspeciesItem.chestColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>é˜ç¿…è‰²ï¼š</label><div class="color-group"><select v-model="currentSubspeciesItem.sheathColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="currentSubspeciesItem.sheathColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>å¤‡æ³¨ï¼š</label><input v-model="currentSubspeciesItem.remark"></div>
                <div style="display:flex; gap:8px; margin-top:15px">
                    <button @click="saveSubspeciesDetail" style="flex:1">ä¿å­˜</button>
                    <button @click="deleteSubspeciesItem" class="delete-btn">åˆ é™¤</button>
                </div>
            </div>
        </div>

        <!-- æ¬¡çº§ç§è®¾ç½®å¼¹çª— -->
        <div class="modal-mask" :class="{active: isSubspeciesModalOpen}" @click="closeSubspeciesModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h3>è®¾ä¸ºæ¬¡çº§ç§</h3>
                    <button @click="closeSubspeciesModal" class="modal-close">Ã—</button>
                </div>
                <div>
                    <div style="font-weight:600; margin-bottom:8px">æ¬¡çº§ç§ç¼–å·</div>
                    <div style="display:flex; gap:8px; margin-bottom:10px">
                        <input v-model="newSubspeciesCode" placeholder="è¾“å…¥ç¼–å·" style="flex:1; padding:7px; border:1px solid #cbd5e0; border-radius:4px;">
                        <button class="add-subspecies-btn" @click="addSubspeciesCode" :disabled="!newSubspeciesCode.trim()">+åŠ ç¼–å·</button>
                    </div>
                    <div class="subspecies-code-wrap" v-if="currentSubspecies.codes.length > 0">
                        <div class="subspecies-code-item" v-for="(code,idx) in currentSubspecies.codes" :key="idx">{{ code }}<span class="subspecies-code-remove" @click="removeSubspeciesCode(idx)">Ã—</span></div>
                    </div>
                </div>
                <div class="form-group"><label>æ€§åˆ«ï¼š</label><select v-model="currentSubspecies.gender"><option value="male">å…¬</option><option value="female">æ¯</option></select></div>
                <div class="form-group"><label>è›¹é‡(g)ï¼š</label><input v-model="currentSubspecies.pupaWeight"></div>
                <div class="form-group"><label>ä½“é•¿(mm)ï¼š</label><input v-model="currentSubspecies.bodyLength"></div>
                <div class="form-group"><label>èƒ¸è‰²ï¼š</label><div class="color-group"><select v-model="currentSubspecies.chestColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="currentSubspecies.chestColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>é˜ç¿…è‰²ï¼š</label><div class="color-group"><select v-model="currentSubspecies.sheathColor1"><option value="">é¢œè‰²1</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select><select v-model="currentSubspecies.sheathColor2"><option value="">é¢œè‰²2</option><option>ç»¿</option><option>çº¢</option><option>è“</option><option>ç´«</option></select></div></div>
                <div class="form-group"><label>å¤‡æ³¨ï¼š</label><input v-model="currentSubspecies.remark"></div>
                <button @click="saveSubspeciesSetting" class="add-subspecies-btn" style="width:100%; margin-top:10px">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        if(window.Vue) {
            const { createApp } = Vue;
            createApp({
                data() {
                    return {
                        gh: {
                            token: localStorage.getItem('gh_token') || '',
                            owner: localStorage.getItem('gh_owner') || '',
                            repo: localStorage.getItem('gh_repo') || '',
                            path: 'data.json'
                        },
                        ghStatus: { connected: false, message: 'æœªè¿æ¥' },
                        fileSha: '',
                        bloodlineLib: [],
                        categories: [
                            { 
                                id: Date.now()+'init',
                                isOpen: true, 
                                data: [], 
                                subspeciesList: [],
                                selectedMaleId: '', 
                                selectedFemaleId: '',
                                newBloodlineName: '',
                                addCount: 1 
                            }
                        ],
                        newBloodlineGender: 'male',
                        newBloodlineName: '',
                        currentBloodline: {},
                        isAddBloodlineModalOpen: false,
                        isEditBloodlineModalOpen: false,
                        editBloodline: {},
                        isItemDetailModalOpen: false,
                        currentCategoryIndex: -1,
                        currentItem: {},
                        isSubspeciesDetailModalOpen: false,
                        currentSubspeciesItem: {},
                        isSubspeciesModalOpen: false,
                        currentSubspecies: { codes: [], gender: 'male', remark: '', pupaWeight: '', bodyLength: '', chestColor1: '', chestColor2: '', sheathColor1: '', sheathColor2: '' },
                        newSubspeciesCode: ''
                    };
                },
                computed: {
                    maleBloodlines() { return this.bloodlineLib.filter(bl => bl.gender === 'male'); },
                    femaleBloodlines() { return this.bloodlineLib.filter(bl => bl.gender === 'female'); }
                },
                methods: {
                    addNewCBFCategory() {
                        const newCBF = {
                            id: Date.now()+'-cbf-'+this.categories.length,
                            isOpen: false,
                            data: [],
                            subspeciesList: [],
                            selectedMaleId: '',
                            selectedFemaleId: '',
                            newBloodlineName: '',
                            addCount: 1
                        };
                        this.categories.push(newCBF);
                        setTimeout(()=>this.syncToCloud(),200);
                    },
                    getMaleOptionList(index) {
                        if(index === 0) return this.maleBloodlines;
                        const prev = this.categories[index-1];
                        return prev ? prev.subspeciesList.filter(i => i.gender === 'male') : [];
                    },
                    getFemaleOptionList(index) {
                        if(index === 0) return this.femaleBloodlines;
                        const prev = this.categories[index-1];
                        return prev ? prev.subspeciesList.filter(i => i.gender === 'female') : [];
                    },
                    getSubspeciesMale(index){
                        return this.categories[index]?.subspeciesList.filter(i => i.gender === 'male') || [];
                    },
                    getSubspeciesFemale(index){
                        return this.categories[index]?.subspeciesList.filter(i => i.gender === 'female') || [];
                    },
                    saveConfig() {
                        localStorage.setItem('gh_token', this.gh.token);
                        localStorage.setItem('gh_owner', this.gh.owner);
                        localStorage.setItem('gh_repo', this.gh.repo);
                        this.loadFromGitHub();
                    },
                    async loadFromGitHub() {
                        if(!this.gh.token || !this.gh.owner || !this.gh.repo) return;
                        try {
                            const res = await fetch(`https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}?t=${Date.now()}`,{
                                headers: {'Authorization': `token ${this.gh.token}`}
                            });
                            if(res.ok){
                                const json = await res.json();
                                this.fileSha = json.sha;
                                const data = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                                this.bloodlineLib = data.bloodlineLib || [];
                                this.categories = data.categories || this.categories;
                                this.ghStatus = {connected: true, message: 'å·²è¿æ¥'};
                            }else{
                                this.ghStatus = {connected: false, message: 'æ— data.json'};
                            }
                        }catch(e){
                            this.ghStatus = {connected: false, message: 'åŒæ­¥å¤±è´¥'};
                        }
                    },
                    async syncToCloud() {
                        if(!this.ghStatus.connected) return;
                        try{
                            const content = btoa(unescape(encodeURIComponent(JSON.stringify({
                                bloodlineLib: this.bloodlineLib,
                                categories: this.categories
                            }, null, 2))));
                            const res = await fetch(`https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}`,{
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${this.gh.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: "Update",
                                    content: content,
                                    sha: this.fileSha
                                })
                            });
                            if(res.ok) this.fileSha = (await res.json()).content.sha;
                        }catch(e){
                            console.log('åŒæ­¥å¤±è´¥', e);
                        }
                    },
                    toggleCategory(index) {
                        this.categories[index].isOpen = !this.categories[index].isOpen;
                    },
                    addBloodlineToCBF(cbfIndex) {
                        const cbf = this.categories[cbfIndex];
                        let maleBl, femaleBl;
                        if(cbfIndex === 0){
                            maleBl = this.maleBloodlines.find(i => i.id === cbf.selectedMaleId);
                            femaleBl = this.femaleBloodlines.find(i => i.id === cbf.selectedFemaleId);
                        }else{
                            const prev = this.categories[cbfIndex-1];
                            maleBl = prev.subspeciesList.find(i => i.id === cbf.selectedMaleId);
                            femaleBl = prev.subspeciesList.find(i => i.id === cbf.selectedFemaleId);
                        }
                        if(!maleBl || !femaleBl) return;
                        
                        cbf.data.push({
                            id: Date.now().toString(),
                            bloodline: cbf.newBloodlineName.trim(),
                            count: cbf.addCount,
                            fatherId: maleBl.id,
                            fatherName: cbfIndex === 0 ? maleBl.bloodline : `${maleBl.bloodline}(${maleBl.code})`,
                            motherId: femaleBl.id,
                            motherName: cbfIndex === 0 ? femaleBl.bloodline : `${femaleBl.bloodline}(${femaleBl.code})`,
                            parentRelation: `${maleBl.bloodline}Ã—${femaleBl.bloodline}`,
                            remark: ''
                        });
                        this.syncToCloud();
                        cbf.selectedMaleId = cbf.selectedFemaleId = cbf.newBloodlineName = '';
                        cbf.addCount = 1;
                    },
                    openAddBloodlineModal() {
                        this.currentBloodline = {
                            id: Date.now().toString(),
                            gender: this.newBloodlineGender,
                            bloodline: this.newBloodlineName || '',
                            bodyLength: '',
                            chestColor1: '',
                            chestColor2: '',
                            sheathColor1: '',
                            sheathColor2: '',
                            remark: ''
                        };
                        this.isAddBloodlineModalOpen = true;
                    },
                    closeAddBloodlineModal() {
                        this.isAddBloodlineModalOpen = false;
                        this.newBloodlineName = '';
                    },
                    saveBloodline() {
                        if(!this.currentBloodline.bloodline.trim()){
                            alert('è¡€è„‰åå¿…å¡«');
                            return;
                        }
                        this.bloodlineLib.push(this.currentBloodline);
                        this.syncToCloud();
                        this.closeAddBloodlineModal();
                        alert('æ·»åŠ æˆåŠŸ');
                    },
                    openEditBloodlineModal(bl) {
                        this.editBloodline = JSON.parse(JSON.stringify(bl));
                        this.isEditBloodlineModalOpen = true;
                    },
                    closeEditBloodlineModal() {
                        this.isEditBloodlineModalOpen = false;
                    },
                    saveEditBloodline() {
                        const idx = this.bloodlineLib.findIndex(i => i.id === this.editBloodline.id);
                        if(idx > -1){
                            this.bloodlineLib[idx] = this.editBloodline;
                            this.syncToCloud();
                            this.closeEditBloodlineModal();
                            alert('ä¿®æ”¹æˆåŠŸ');
                        }
                    },
                    openItemDetailModal(cbfIndex, item) { 
                        this.currentCategoryIndex = cbfIndex;
                        this.currentItem = JSON.parse(JSON.stringify(item));
                        this.isItemDetailModalOpen = true;
                    },
                    closeItemDetailModal() {
                        this.isItemDetailModalOpen = false;
                        this.currentItem = {};
                    },
                    saveItemDetail() {
                        const cbf = this.categories[this.currentCategoryIndex];
                        const idx = cbf.data.findIndex(i => i.id === this.currentItem.id);
                        if(idx > -1){
                            cbf.data[idx] = this.currentItem;
                            this.syncToCloud();
                            this.closeItemDetailModal();
                            alert('ä¿å­˜æˆåŠŸ');
                        }
                    },
                    deleteItem() {
                        if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                        const cbf = this.categories[this.currentCategoryIndex];
                        cbf.data = cbf.data.filter(i => i.id !== this.currentItem.id);
                        cbf.subspeciesList = cbf.subspeciesList.filter(i => i.sourceId !== this.currentItem.id);
                        this.syncToCloud();
                        this.closeItemDetailModal();
                    },
                    openSubspeciesDetailModal(cbfIndex, item) { 
                        this.currentCategoryIndex = cbfIndex;
                        this.currentSubspeciesItem = JSON.parse(JSON.stringify(item));
                        this.isSubspeciesDetailModalOpen = true;
                    },
                    closeSubspeciesDetailModal() {
                        this.isSubspeciesDetailModalOpen = false;
                        this.currentSubspeciesItem = {};
                    },
                    saveSubspeciesDetail() {
                        const cbf = this.categories[this.currentCategoryIndex];
                        const idx = cbf.subspeciesList.findIndex(i => i.id === this.currentSubspeciesItem.id);
                        if(idx > -1){
                            cbf.subspeciesList[idx] = this.currentSubspeciesItem;
                            this.syncToCloud();
                            this.closeSubspeciesDetailModal();
                            alert('ä¿å­˜æˆåŠŸ');
                        }
                    },
                    deleteSubspeciesItem() {
                        if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                        const cbf = this.categories[this.currentCategoryIndex];
                        cbf.subspeciesList = cbf.subspeciesList.filter(i => i.id !== this.currentSubspeciesItem.id);
                        this.syncToCloud();
                        this.closeSubspeciesDetailModal();
                    },
                    openSubspeciesModal() {
                        this.currentSubspecies = {
                            codes: [],
                            gender: 'male',
                            remark: '',
                            pupaWeight: '',
                            bodyLength: '',
                            chestColor1: '',
                            chestColor2: '',
                            sheathColor1: '',
                            sheathColor2: ''
                        };
                        this.newSubspeciesCode = '';
                        this.isSubspeciesModalOpen = true;
                    },
                    closeSubspeciesModal() {
                        this.isSubspeciesModalOpen = false;
                    },
                    addSubspeciesCode() {
                        if(!this.newSubspeciesCode.trim() || this.currentSubspecies.codes.includes(this.newSubspeciesCode)) return;
                        this.currentSubspecies.codes.push(this.newSubspeciesCode);
                        this.newSubspeciesCode = '';
                    },
                    removeSubspeciesCode(idx) {
                        this.currentSubspecies.codes.splice(idx, 1);
                    },
                    saveSubspeciesSetting() {
                        if(!this.currentSubspecies.codes.length){
                            alert('è¯·æ·»åŠ æ¬¡çº§ç§ç¼–å·');
                            return;
                        }
                        const cbf = this.categories[this.currentCategoryIndex];
                        cbf.subspeciesList.push({
                            id: Date.now().toString(),
                            sourceId: this.currentItem.id,
                            bloodline: this.currentItem.bloodline,
                            code: this.currentSubspecies.codes.join(','),
                            gender: this.currentSubspecies.gender,
                            fatherName: this.currentItem.fatherName,
                            motherName: this.currentItem.motherName,
                            remark: this.currentSubspecies.remark,
                            pupaWeight: this.currentSubspecies.pupaWeight,
                            bodyLength: this.currentSubspecies.bodyLength,
                            chestColor1: this.currentSubspecies.chestColor1,
                            chestColor2: this.currentSubspecies.chestColor2,
                            sheathColor1: this.currentSubspecies.sheathColor1,
                            sheathColor2: this.currentSubspecies.sheathColor2
                        });
                        this.syncToCloud();
                        this.closeSubspeciesModal();
                        this.closeItemDetailModal();
                        alert('è®¾ä¸ºæ¬¡çº§ç§æˆåŠŸ');
                    }
                },
                mounted() {
                    this.loadFromGitHub();
                }
            }).mount('#app');
        }else{
            document.write('VueåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    </script>
</body>
</html>
